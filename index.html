<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Brotton Surgery – UTI Screening (Reception)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.4;
      color: #111827;
      background: #f3f4f6;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem 1rem 2rem;
    }
    header {
      background: #111827;
      color: white;
      padding: 1rem;
      border-radius: 0 0 0.75rem 0.75rem;
      margin: 0 -1rem 1rem -1rem;
    }
    h1 {
      font-size: 1.35rem;
      margin: 0 0 0.25rem 0;
    }
    h2 {
      font-size: 1.2rem;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    h3 {
      font-size: 1.05rem;
      margin-top: 1.25rem;
      margin-bottom: 0.35rem;
    }
    p {
      margin: 0.35rem 0;
    }

    .card {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.1);
    }
    .section-hidden {
      display: none;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    button {
      cursor: pointer;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      border: 1px solid #d1d5db;
      background: #111827;
      color: white;
      font-size: 0.95rem;
    }
    button.secondary {
      background: white;
      color: #111827;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .notice {
      border-radius: 0.75rem;
      padding: 0.75rem;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    .notice.warning {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #7f1d1d;
    }
    .notice.info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1d4ed8;
    }
    .notice.neutral {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      color: #111827;
    }

    .small {
      font-size: 0.85rem;
      color: #e5e7eb;
      margin-top: 0.25rem;
    }
    .small-dark {
      font-size: 0.85rem;
      color: #4b5563;
      margin-top: 0.35rem;
    }

    .checkbox-list label {
      display: flex;
      align-items: flex-start;
      gap: 0.4rem;
      margin: 0.25rem 0;
      font-size: 0.95rem;
    }
    .checkbox-list input[type="checkbox"] {
      margin-top: 0.15rem;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      box-sizing: border-box;
      margin-top: 0.15rem;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .summary-box {
      white-space: pre-wrap;
      background: #111827;
      color: #f9fafb;
      border-radius: 0.75rem;
      padding: 0.75rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      max-height: 320px;
      overflow-y: auto;
    }

    .footer-text {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.75rem;
    }

    @media (max-width: 640px) {
      .app {
        padding: 0.5rem 0.75rem 1.5rem;
      }
      header {
        margin: 0 -0.75rem 0.75rem -0.75rem;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>UTI Screening Helper – Reception</h1>
    <p>
      For <strong>non-clinical reception/admin staff</strong> taking calls about possible urine infections.
      This tool supports – but does not replace – clinical judgement or local emergency policy.
    </p>
    <p class="small">
      Do not enter patient names, dates of birth, or phone numbers here.  
      Reception should already have the patient record open in the clinical system.
    </p>
  </header>

  <!-- STEP 1 – PATIENT GROUP -->
  <section id="home" class="card">
    <h2>Step 1 – Who is the patient?</h2>
    <p>Ask who the problem is for and choose the best match below.</p>

    <div class="btn-row">
      <button onclick="choosePatientType('adult_under65_female')">
        Adult woman under 65 (not pregnant, no catheter)
      </button>
      <button onclick="choosePatientType('adult_over65_or_catheter')">
        Adult 65 or over, or any adult with a catheter
      </button>
      <button onclick="choosePatientType('adult_pregnant')">
        Pregnant adult (any age)
      </button>
      <button onclick="choosePatientType('adult_male')">
        Adult man (no catheter, not already covered above)
      </button>
      <button onclick="choosePatientType('child')">
        Child or young person (under 16)
      </button>
    </div>

    <p class="small-dark">
      If at any point the patient seems very unwell, confused, or you are worried they may be seriously ill,  
      follow your practice’s emergency procedure straight away (duty GP / 999) – do not rely on this tool.
    </p>
  </section>

  <!-- STEP 2 – SEPSIS SCREEN -->
  <section id="sepsis-section" class="card section-hidden">
    <h2>Step 2 – Check for serious illness (sepsis screen)</h2>
    <p><strong>Say:</strong> “I’m going to ask a few quick questions to check for any serious warning signs.”</p>

    <div class="checkbox-list">
      <label><input type="checkbox" class="sepsis-check" value="very_unwell">
        Do they feel <strong>very unwell</strong> or “not like themselves”, or are you really worried about them?
      </label>
      <label><input type="checkbox" class="sepsis-check" value="confused">
        Are they <strong>confused, not making sense, hard to wake</strong>, or acting very differently to normal?
      </label>
      <label><input type="checkbox" class="sepsis-check" value="breathing">
        Are they <strong>struggling to breathe</strong> or breathing much faster than usual?
      </label>
      <label><input type="checkbox" class="sepsis-check" value="skin">
        Is their <strong>skin, lips or tongue</strong> looking <strong>blue, very pale, or blotchy/mottled</strong>?
      </label>
      <label><input type="checkbox" class="sepsis-check" value="no_wee">
        Have they <strong>passed very little or no urine today</strong> (much less than usual)?
      </label>
      <label><input type="checkbox" class="sepsis-check" value="shivers">
        Are they having <strong>shaking chills</strong>, feeling freezing cold and shivery with a high temperature?
      </label>
      <label><input type="checkbox" class="sepsis-check" value="severe_pain">
        Do they have <strong>very severe pain</strong> anywhere, that is not eased by simple pain relief?
      </label>
    </div>

    <div id="sepsis-alert" class="notice neutral">
      If you tick any of these, stop and follow local emergency policy (duty clinician / 999).
    </div>

    <div class="btn-row">
      <button onclick="goToSymptomsStep()">Next – go to urine symptoms</button>
      <button class="secondary" onclick="resetAndGoHome()">Cancel and start again</button>
    </div>
  </section>

  <!-- STEP 3 – SYMPTOMS: ADULT WOMAN <65 -->
  <section id="adult_under65_female-section" class="card section-hidden">
    <h2>Step 3 – Symptoms (adult woman under 65, not pregnant, no catheter)</h2>

    <p><strong>Ask:</strong> “Can you tell me what problems you’re having with passing urine?”</p>

    <h3>Key UTI symptoms</h3>
    <div class="checkbox-list">
      <label><input type="checkbox" class="symptom-wu65" value="dysuria">
        Burning, stinging or pain when passing urine
      </label>
      <label><input type="checkbox" class="symptom-wu65" value="new_nocturia">
        Getting up to pass urine at night more often than usual (new or much worse)
      </label>
      <label><input type="checkbox" class="symptom-wu65" value="cloudy_urine">
        Urine looking cloudy to the eye
      </label>
    </div>

    <h3>Other urinary symptoms</h3>
    <div class="checkbox-list">
      <label><input type="checkbox" class="symptom-wu65" value="frequency">
        Passing urine much more often than usual
      </label>
      <label><input type="checkbox" class="symptom-wu65" value="urgency">
        A sudden strong urge to pass urine, needing to rush to the toilet
      </label>
      <label><input type="checkbox" class="symptom-wu65" value="suprapubic">
        Pain or discomfort in the lower tummy (just above the pubic area)
      </label>
      <label><input type="checkbox" class="symptom-wu65" value="visible_blood">
        Seeing blood in the urine
      </label>
    </div>

    <h3>Possible kidney infection – ask:</h3>
    <div class="checkbox-list">
      <label><input type="checkbox" class="pyelo" value="kidney_pain">
        Pain in the back or side, under the ribs (where the kidneys are)
      </label>
      <label><input type="checkbox" class="pyelo" value="rigors">
        Shaking chills or feeling very hot and very cold
      </label>
      <label><input type="checkbox" class="pyelo" value="flu_like">
        Flu-like symptoms or aching all over
      </label>
      <label><input type="checkbox" class="pyelo" value="nausea_vomiting">
        Feeling sick or vomiting with the urine symptoms
      </label>
    </div>

    <h3>Background questions</h3>
    <label>How long have the symptoms been going on?
      <input id="wu65-duration" type="text" placeholder="e.g. 2 days, 1 week">
    </label>
    <label>Are they pregnant? (If yes, use the pregnant pathway instead.)
      <select id="wu65-pregnant">
        <option value="">Select</option>
        <option value="no">No</option>
        <option value="yes">Yes – should be on pregnant pathway</option>
        <option value="unsure">Not sure</option>
      </select>
    </label>
    <label>Any urine catheter in place?
      <select id="wu65-catheter">
        <option value="">Select</option>
        <option value="no">No</option>
        <option value="yes">Yes – should be on catheter pathway</option>
      </select>
    </label>
    <label>Any recent urine infections treated with antibiotics in the last 3 months?
      <select id="wu65-recurrent">
        <option value="">Select</option>
        <option value="no">No</option>
        <option value="yes">Yes – recurrent or recent UTI</option>
      </select>
    </label>

    <div class="btn-row">
      <button onclick="goToAdviceStep()">Next – what to say to the caller</button>
      <button class="secondary" onclick="resetAndGoHome()">Cancel and start again</button>
    </div>
  </section>

  <!-- STEP 3 – SYMPTOMS: ADULT 65+ OR CATHETER -->
  <section id="adult_over65_or_catheter-section" class="card section-hidden">
    <h2>Step 3 – Symptoms (adult 65+ or any adult with a catheter)</h2>

    <p>
      For older adults and people with catheters, focus on <strong>new</strong> urinary symptoms and how unwell they seem.
    </p>

    <h3>Local urinary symptoms – are these new or worse?</h3>
    <div class="checkbox-list">
      <label><input type="checkbox" class="symptom-o65" value="dysuria">
        Burning, stinging or pain when passing urine
      </label>
      <label><input type="checkbox" class="symptom-o65" value="urgency">
        Needing to rush to the toilet to pass urine
      </label>
      <label><input type="checkbox" class="symptom-o65" value="frequency">
        Passing urine much more often than usual
      </label>
      <label><input type="checkbox" class="symptom-o65" value="incontinence">
        New or much worse leaking of urine
      </label>
      <label><input type="checkbox" class="symptom-o65" value="suprapubic">
        New lower tummy pain or discomfort (above the pubic area)
      </label>
      <label><input type="checkbox" class="symptom-o65" value="visible_blood">
        Seeing blood in the urine
      </label>
    </div>

    <h3>General symptoms – check which are NEW or much worse:</h3>
    <div class="checkbox-list">
      <label><input type="checkbox" class="symptom-o65" value="delirium">
        Sudden confusion, drowsiness or change in behaviour
      </label>
      <label><input type="checkbox" class="symptom-o65" value="shivers">
        Shaking chills or feeling very hot and very cold
      </label>
      <label><input type="checkbox" class="symptom-o65" value="unwell">
        Much more unsteady, weak or “not themselves”
      </label>
      <label><input type="checkbox" class="symptom-o65" value="fever">
        Fever or feeling hot and sweaty
      </label>
    </div>

    <h3>If they have a catheter:</h3>
    <div class="checkbox-list">
      <label><input type="checkbox" class="symptom-o65" value="catheter_block">
        Catheter not draining properly or blocked
      </label>
      <label><input type="checkbox" class="symptom-o65" value="catheter_change">
        Bag or urine suddenly looks different (e.g. much more cloudy, strong smell, new blood)
      </label>
    </div>

    <label>How long have the symptoms been going on?
      <input id="o65-duration" type="text" placeholder="e.g. today, 3 days, 1 week">
    </label>
    <label>Do they live in a care home or receive regular care?
      <select id="o65-carehome">
        <option value="">Select</option>
        <option value="no">No</option>
        <option value="yes">Yes – care home / regular carer involvement</option>
      </select>
    </label>

    <div class="btn-row">
      <button onclick="goToAdviceStep()">Next – what to say to the caller</button>
      <button class="secondary" onclick="resetAndGoHome()">Cancel and start again</button>
    </div>
  </section>

  <!-- STEP 3 – SYMPTOMS: PREGNANT ADULT -->
  <section id="adult_pregnant-section" class="card section-hidden">
    <h2>Step 3 – Symptoms (pregnant adult)</h2>

    <p><strong>Note for reception:</strong> Pregnancy with urine symptoms usually needs same-day clinical review
      and a urine sample.</p>

    <h3>Pregnancy details</h3>
    <label>How many weeks pregnant are they (if known)?
      <input id="preg-weeks" type="text" placeholder="e.g. 10 weeks, 24 weeks">
    </label>
    <label>Any pregnancy complications you are aware of? (free text)
      <textarea id="preg-complications" placeholder="e.g. high blood pressure, diabetes, previous kidney problems"></textarea>
    </label>

    <h3>Urinary symptoms</h3>
    <div class="checkbox-list">
      <label><input type="checkbox" class="symptom-preg" value="dysuria">
        Burning, stinging or pain when passing urine
      </label>
      <label><input type="checkbox" class="symptom-preg" value="frequency">
        Passing urine much more often than usual
      </label>
      <label><input type="checkbox" class="symptom-preg" value="urgency">
        Needing to rush to the toilet to pass urine
      </label>
      <label><input type="checkbox" class="symptom-preg" value="visible_blood">
        Seeing blood in the urine
      </label>
      <label><input type="checkbox" class="symptom-preg" value="suprapubic">
        Pain or discomfort in the lower tummy (above the pubic area)
      </label>
    </div>

    <h3>Possible kidney infection</h3>
    <div class="checkbox-list">
      <label><input type="checkbox" class="pyelo" value="kidney_pain">
        Pain in the back or side, under the ribs
      </label>
      <label><input type="checkbox" class="pyelo" value="rigors">
        Shaking chills or feeling very hot and very cold
      </label>
      <label><input type="checkbox" class="pyelo" value="flu_like">
        Flu-like symptoms or aching all over
      </label>
      <label><input type="checkbox" class="pyelo" value="nausea_vomiting">
        Feeling sick or vomiting with the urine symptoms
      </label>
    </div>

    <label>How long have the symptoms been going on?
      <input id="preg-duration" type="text">
    </label>

    <div class="btn-row">
      <button onclick="goToAdviceStep()">Next – what to say to the caller</button>
      <button class="secondary" onclick="resetAndGoHome()">Cancel and start again</button>
    </div>
  </section>

  <!-- STEP 3 – SYMPTOMS: ADULT MALE -->
  <section id="adult_male-section" class="card section-hidden">
    <h2>Step 3 – Symptoms (adult man, no catheter)</h2>

    <p><strong>Note for reception:</strong> UTIs are less common in men and usually need clinical review
      and a urine test.</p>

    <h3>Urinary symptoms</h3>
    <div class="checkbox-list">
      <label><input type="checkbox" class="symptom-male" value="dysuria">
        Burning, stinging or pain when passing urine
      </label>
      <label><input type="checkbox" class="symptom-male" value="frequency">
        Passing urine much more often than usual
      </label>
      <label><input type="checkbox" class="symptom-male" value="urgency">
        Needing to rush to the toilet to pass urine
      </label>
      <label><input type="checkbox" class="symptom-male" value="suprapubic">
        Pain or discomfort in the lower tummy (above the pubic area)
      </label>
      <label><input type="checkbox" class="symptom-male" value="visible_blood">
        Seeing blood in the urine
      </label>
    </div>

    <h3>Other questions</h3>
    <label>Any pain in the testicles, or discomfort between the legs and back passage?
      <select id="male-prostate">
        <option value="">Select</option>
        <option value="no">No</option>
        <option value="yes">Yes – possible prostate / testicular problem</option>
      </select>
    </label>
    <label>How long have the symptoms been going on?
      <input id="male-duration" type="text">
    </label>

    <div class="btn-row">
      <button onclick="goToAdviceStep()">Next – what to say to the caller</button>
      <button class="secondary" onclick="resetAndGoHome()">Cancel and start again</button>
    </div>
  </section>

  <!-- STEP 3 – SYMPTOMS: CHILD -->
  <section id="child-section" class="card section-hidden">
    <h2>Step 3 – Symptoms (child or young person under 16)</h2>

    <p><strong>Note:</strong> Children with possible urine infection usually need urine testing and
      clinical review.</p>

    <h3>Ask the parent/carer:</h3>
    <label>Child’s age
      <input id="child-age" type="text" placeholder="e.g. 3 years, 8 months">
    </label>

    <div class="checkbox-list">
      <label><input type="checkbox" class="symptom-child" value="fever">
        Fever (hot to touch) with no obvious other cause (like a cold or sore throat)
      </label>
      <label><input type="checkbox" class="symptom-child" value="dysuria">
        Crying or complaining of pain when passing urine
      </label>
      <label><input type="checkbox" class="symptom-child" value="frequency">
        Passing urine much more often than usual, or rushing to the toilet
      </label>
      <label><input type="checkbox" class="symptom-child" value="wetting">
        New wetting episodes in a toilet-trained child
      </label>
      <label><input type="checkbox" class="symptom-child" value="tummy_pain">
        Tummy pain or discomfort
      </label>
      <label><input type="checkbox" class="symptom-child" value="vomiting">
        Being sick with the above symptoms
      </label>
      <label><input type="checkbox" class="symptom-child" value="unwell">
        Generally unwell, off food or drink, more sleepy than usual
      </label>
    </div>

    <label>How long have the symptoms been going on?
      <input id="child-duration" type="text">
    </label>

    <div class="btn-row">
      <button onclick="goToAdviceStep()">Next – what to say to the caller</button>
      <button class="secondary" onclick="resetAndGoHome()">Cancel and start again</button>
    </div>
  </section>

  <!-- STEP 4 – ADVICE TO CALLER -->
  <section id="advice-section" class="card section-hidden">
    <h2>Step 4 – Suggested wording to the caller</h2>
    <p>
      Reception: you can use or adapt this wording to close the call.
      Once you have finished speaking to the caller, go to the next step to copy the GP summary.
    </p>

    <div id="advice-text" class="notice info"></div>

    <div class="btn-row">
      <button onclick="goToSummaryStep()">Next – clinical summary for GP</button>
      <button class="secondary" onclick="resetAndGoHome()">Start again</button>
    </div>
  </section>

  <!-- STEP 5 – CLINICAL SUMMARY -->
  <section id="summary-section" class="card section-hidden">
    <h2>Step 5 – Clinical summary for the GP record</h2>
    <p>
      Reception: copy this text into the clinical system (e.g. admin note / consultation entry)
      after you have finished the call.
    </p>

    <div class="btn-row">
      <button onclick="copySummary()">Copy summary to clipboard</button>
      <button class="secondary" onclick="resetAndGoHome()">New call</button>
    </div>

    <h3>Text to paste into SystmOne / EMIS / Vision</h3>
    <div id="summary-text" class="summary-box"></div>

    <p class="footer-text">
      This note contains no patient-identifiable information.  
      It assumes identity has already been confirmed in the clinical system by reception.
    </p>
  </section>
</div>

<script>
  let currentPatientType = null;
  let sepsisFlagged = false;

  function showSections(ids) {
    const sections = document.querySelectorAll("section.card");
    sections.forEach(sec => sec.classList.add("section-hidden"));
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.remove("section-hidden");
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function resetFormFields() {
    document.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
    document.querySelectorAll("input[type='text'], textarea, select").forEach(el => el.value = "");
    document.getElementById("advice-text").innerText = "";
    document.getElementById("summary-text").innerText = "";
    const sepsisAlert = document.getElementById("sepsis-alert");
    if (sepsisAlert) {
      sepsisAlert.className = "notice neutral";
      sepsisAlert.innerText = "If you tick any of these, stop and follow local emergency policy (duty clinician / 999).";
    }
  }

  function resetAndGoHome() {
    currentPatientType = null;
    sepsisFlagged = false;
    resetFormFields();
    showSections(["home"]);
  }

  function choosePatientType(type) {
    currentPatientType = type;
    sepsisFlagged = false;
    resetFormFields();
    showSections(["sepsis-section"]);
  }

  // Track sepsis selection for summary + warning banner
  document.addEventListener("change", function (e) {
    if (e.target.classList.contains("sepsis-check")) {
      const anyTicked = Array.from(document.querySelectorAll(".sepsis-check"))
        .some(cb => cb.checked);
      sepsisFlagged = anyTicked;
      const alertBox = document.getElementById("sepsis-alert");
      if (!alertBox) return;
      if (anyTicked) {
        alertBox.className = "notice warning";
        alertBox.innerHTML =
          "<strong>Red flag signs selected.</strong> Stop and follow local emergency policy – " +
          "speak to the duty clinician and/or call 999 as appropriate. " +
          "Only continue if a clinician tells you it is appropriate.";
      } else {
        alertBox.className = "notice neutral";
        alertBox.innerText =
          "If you tick any of these, stop and follow local emergency policy (duty clinician / 999).";
      }
    }
  });

  function goToSymptomsStep() {
    if (!currentPatientType) {
      alert("Please choose the patient group first.");
      return;
    }
    if (sepsisFlagged) {
      const ok = confirm(
        "You have selected one or more red flag signs.\n\n" +
        "You should follow your practice emergency policy (duty clinician / 999) before continuing.\n\n" +
        "Only press OK if a clinician has advised you to carry on using this form."
      );
      if (!ok) return;
    }
    showSections([currentPatientType + "-section"]);
  }

  function getCheckedValues(selector) {
    return Array.from(document.querySelectorAll(selector + ":checked")).map(cb => cb.value);
  }

  function determineUrinePlan() {
    // If red flag / sepsis, we don't request a sample via this tool.
    if (sepsisFlagged) {
      return {
        plan: "none",
        reason: "Red flag features – emergency pathway; urine sample decision left to clinician."
      };
    }

    switch (currentPatientType) {
      case "adult_under65_female": {
        const all = getCheckedValues(".symptom-wu65");
        const keySet = ["dysuria", "new_nocturia", "cloudy_urine"];
        const key = all.filter(v => keySet.includes(v));
        const pyelo = getCheckedValues(".pyelo");
        const recurrent = (document.getElementById("wu65-recurrent").value || "").toLowerCase();
        const hasBlood = all.includes("visible_blood");

        if (pyelo.length > 0 || hasBlood || recurrent === "yes") {
          return {
            plan: "required",
            reason: "Higher-risk features (kidney infection symptoms, visible blood in urine, or recent/recurrent UTI)."
          };
        } else if (key.length < 2) {
          return {
            plan: "recommended",
            reason: "Fewer than two key lower UTI symptoms – urine sample helps confirm diagnosis."
          };
        } else {
          return {
            plan: "none",
            reason: "Typical lower UTI pattern in non-pregnant woman under 65 with ≥2 key symptoms."
          };
        }
      }
      case "adult_male": {
        return {
          plan: "required",
          reason: "Lower urinary symptoms in a man – guideline practice is to send urine for culture."
        };
      }
      case "adult_pregnant": {
        return {
          plan: "required",
          reason: "UTI symptoms in pregnancy – urine testing required in pregnancy."
        };
      }
      case "adult_over65_or_catheter": {
        const symptoms = getCheckedValues(".symptom-o65");
        const hasBlood = symptoms.includes("visible_blood");
        const hasCatheterIssue =
          symptoms.includes("catheter_block") || symptoms.includes("catheter_change");

        if (hasBlood || hasCatheterIssue) {
          return {
            plan: "required",
            reason: "Visible blood or catheter problem with urinary symptoms."
          };
        } else if (symptoms.length > 0) {
          return {
            plan: "recommended",
            reason: "New urinary symptoms in ≥65 / catheter – urine sample helpful to guide treatment."
          };
        } else {
          return {
            plan: "none",
            reason: "No clear new urinary symptoms recorded."
          };
        }
      }
      case "child": {
        return {
          plan: "required",
          reason: "Child with possible UTI – urine testing usually required for diagnosis."
        };
      }
      default:
        return {
          plan: "none",
          reason: "Pathway not selected."
        };
    }
  }

  function buildSampleAdvice(urinePlan, isChild) {
    const plan = urinePlan.plan;
    if (plan === "required") {
      if (isChild) {
        return "\n\nBecause of your child's symptoms, we would like you to bring a urine sample from your child to the surgery today. " +
               "If you have a sample bottle at home, please use that; if not, you can collect one from reception as soon as you can.";
      } else {
        return "\n\nBecause of the symptoms you have described, we would like you to bring a urine sample to the surgery today. " +
               "Please collect a fresh mid-stream sample in a clean sample bottle and hand it in at reception as soon as you can.";
      }
    } else if (plan === "recommended") {
      if (isChild) {
        return "\n\nIt would be very helpful if you could bring a urine sample from your child to the surgery today, " +
               "so the clinician can check for infection.";
      } else {
        return "\n\nIt would be very helpful if you could bring a urine sample to the surgery today, " +
               "so the clinician can check for infection.";
      }
    } else {
      // none
      return "\n\nThe clinician may still ask for a urine sample later, but you do not need to bring one in immediately unless we contact you again.";
    }
  }

  function buildClosingScript(urinePlan) {
    if (sepsisFlagged) {
      return (
        "Because you have described some warning signs that can suggest a serious infection, " +
        "we are treating this as urgent.\n\n" +
        "Please stay by your phone. We will speak to the duty clinician straight away. " +
        "If you feel the patient is getting worse before we call you back – especially if " +
        "they are very drowsy, confused, struggling to breathe, or their skin looks blue or mottled – " +
        "please call 999 for an ambulance."
      );
    }

    const isChild = currentPatientType === "child";
    const sampleText = buildSampleAdvice(urinePlan, isChild);

    switch (currentPatientType) {
      case "adult_under65_female":
        return (
          "Thank you for answering those questions.\n\n" +
          "I will pass this information to the clinician so they can decide the best next step, " +
          "which may include a prescription and/or a review appointment. Please keep your phone with you – " +
          "we will let you know the clinician's plan." +
          sampleText +
          "\n\nIf your symptoms suddenly get much worse, if you develop severe pain in your back under the ribs, " +
          "start vomiting, or feel very unwell, please contact us urgently or call NHS 111/999 as appropriate."
        );
      case "adult_over65_or_catheter":
        return (
          "Thank you for answering those questions.\n\n" +
          "I will pass this information to the clinician so they can review it and decide what to do next. " +
          "That may include arranging a phone call, an appointment or a urine test. Please keep the phone " +
          "with you so we can reach you." +
          sampleText +
          "\n\nIf they become much more confused, very drowsy, very short of breath, stop passing urine, " +
          "or you are very worried they are seriously unwell, please contact us urgently or call 999."
        );
      case "adult_pregnant":
        return (
          "Thank you for answering those questions.\n\n" +
          "Because you are pregnant and have urine symptoms, I will make sure a clinician reviews this " +
          "today and decides on the next step – this may include a same-day appointment and treatment." +
          sampleText +
          "\n\nIf you develop severe pain in your back under the ribs, start vomiting, feel very unwell, " +
          "or have any concerns about your pregnancy, call us urgently or phone NHS 111/999 as appropriate."
        );
      case "adult_male":
        return (
          "Thank you for answering those questions.\n\n" +
          "I will pass this information to a clinician so they can decide what needs to happen next – " +
          "this usually includes a review and a urine test. Please keep your phone with you " +
          "so we can let you know the plan." +
          sampleText +
          "\n\nIf the pain becomes severe, you see a lot of blood in the urine, or you feel very unwell, " +
          "please contact us urgently or call NHS 111/999 as appropriate."
        );
      case "child":
        return (
          "Thank you for answering those questions.\n\n" +
          "I will pass this information to a clinician so they can decide on the best next step – " +
          "this may include a same-day review and treatment, depending on how your child is." +
          sampleText +
          "\n\nIf your child becomes very drowsy, difficult to wake, has breathing problems, " +
          "a rash that does not fade with a glass, or you are very worried they are seriously unwell, " +
          "please seek urgent help via 999 or A&E."
        );
      default:
        return (
          "Thank you for your call.\n\n" +
          "We will pass this information to a clinician who will review it and decide on the next step. " +
          "Please keep your phone with you so we can let you know their plan."
        );
    }
  }

  function buildSummaryForCurrentPath(urinePlan) {
    const lines = [];

    lines.push("Admin UTI screening call (reception tool).");
    lines.push("Patient identity confirmed in clinical system by reception before using this tool.");
    lines.push("No patient-identifiable data recorded on the website.");
    lines.push("");

    const sepsisTicks = getCheckedValues(".sepsis-check");
    if (sepsisTicks.length > 0) {
      lines.push(
        "Sepsis screen: RED FLAG features reported (" + sepsisTicks.join(", ") +
        "). Reception advised to follow emergency procedure (duty clinician / 999) before or during this call."
      );
    } else {
      lines.push("Sepsis screen: no red flag features reported by caller.");
    }
    lines.push("");

    switch (currentPatientType) {
      case "adult_under65_female": {
        const keySymptoms = getCheckedValues(".symptom-wu65");
        const pyelo = getCheckedValues(".pyelo");
        const duration = (document.getElementById("wu65-duration").value || "").trim() || "not stated";
        const pregnant = document.getElementById("wu65-pregnant").value || "not recorded";
        const catheter = document.getElementById("wu65-catheter").value || "not recorded";
        const recurrent = document.getElementById("wu65-recurrent").value || "not recorded";

        lines.push("Pathway: Adult woman <65, not pregnant, no catheter (self-reported).");
        lines.push("Duration of urinary symptoms: " + duration + ".");
        lines.push(
          "Urinary symptoms reported: " +
          (keySymptoms.length ? keySymptoms.join(", ") : "none of the listed symptoms ticked") +
          "."
        );
        if (pyelo.length) {
          lines.push("Possible kidney infection features: " + pyelo.join(", ") + ".");
        } else {
          lines.push("Possible kidney infection features: none of the listed features ticked.");
        }
        lines.push("Pregnancy status (caller report): " + pregnant + ".");
        lines.push("Urinary catheter: " + catheter + ".");
        lines.push("Recent/recurrent UTI in last 3 months: " + recurrent + ".");
        break;
      }
      case "adult_over65_or_catheter": {
        const symptoms = getCheckedValues(".symptom-o65");
        const duration = (document.getElementById("o65-duration").value || "").trim() || "not stated";
        const carehome = document.getElementById("o65-carehome").value || "not recorded";

        lines.push("Pathway: Adult ≥65 and/or catheterised adult.");
        lines.push("Duration of symptoms: " + duration + ".");
        lines.push(
          "New/worse symptoms reported: " +
          (symptoms.length ? symptoms.join(", ") : "none of the listed symptoms ticked") +
          "."
        );
        lines.push("Care home / regular care involvement: " + carehome + ".");
        break;
      }
      case "adult_pregnant": {
        const symptoms = getCheckedValues(".symptom-preg");
        const pyelo = getCheckedValues(".pyelo");
        const duration = (document.getElementById("preg-duration").value || "").trim() || "not stated";
        const weeks = (document.getElementById("preg-weeks").value || "").trim() || "not stated";
        const complications = (document.getElementById("preg-complications").value || "").trim() || "none reported";

        lines.push("Pathway: Pregnant adult with urinary symptoms.");
        lines.push("Gestation (caller report): " + weeks + ".");
        lines.push("Known pregnancy complications (caller report): " + complications + ".");
        lines.push(
          "Urinary symptoms reported: " +
          (symptoms.length ? symptoms.join(", ") : "none of the listed symptoms ticked") +
          "."
        );
        if (pyelo.length) {
          lines.push("Possible kidney infection features: " + pyelo.join(", ") + ".");
        } else {
          lines.push("Possible kidney infection features: none of the listed features ticked.");
        }
        lines.push("Duration of symptoms: " + duration + ".");
        break;
      }
      case "adult_male": {
        const symptoms = getCheckedValues(".symptom-male");
        const duration = (document.getElementById("male-duration").value || "").trim() || "not stated";
        const prostate = document.getElementById("male-prostate").value || "not recorded";

        lines.push("Pathway: Adult man with urinary symptoms (no indwelling catheter).");
        lines.push(
          "Urinary symptoms reported: " +
          (symptoms.length ? symptoms.join(", ") : "none of the listed symptoms ticked") +
          "."
        );
        lines.push("Prostate/testicular discomfort: " + prostate + ".");
        lines.push("Duration of symptoms: " + duration + ".");
        break;
      }
      case "child": {
        const symptoms = getCheckedValues(".symptom-child");
        const duration = (document.getElementById("child-duration").value || "").trim() || "not stated";
        const age = (document.getElementById("child-age").value || "").trim() || "not stated";

        lines.push("Pathway: Child / young person (<16) with possible UTI.");
        lines.push("Child age (caller report): " + age + ".");
        lines.push(
          "Symptoms reported: " +
          (symptoms.length ? symptoms.join(", ") : "none of the listed symptoms ticked") +
          "."
        );
        lines.push("Duration of symptoms: " + duration + ".");
        break;
      }
      default:
        lines.push("Pathway: not recorded.");
    }

    lines.push("");
    // Urine sample summary
    if (urinePlan.plan === "required") {
      lines.push(
        "Urine sample: Reception has asked the patient/parent to provide a urine sample today " +
        "(reason: " + urinePlan.reason + ")."
      );
    } else if (urinePlan.plan === "recommended") {
      lines.push(
        "Urine sample: Reception has suggested providing a urine sample today " +
        "(reason: " + urinePlan.reason + ")."
      );
    } else {
      lines.push(
        "Urine sample: Not specifically requested during this call via this tool (" +
        urinePlan.reason + ")."
      );
    }
    lines.push("");

    lines.push("Reception action summary:");
    if (sepsisFlagged) {
      lines.push("- Red flag features present – emergency policy triggered (duty clinician / 999 as appropriate).");
    } else {
      switch (currentPatientType) {
        case "adult_under65_female":
          lines.push("- Adult woman <65 with urinary symptoms. Requires GP/ANP review according to duty rota.");
          break;
        case "adult_over65_or_catheter":
          lines.push("- ≥65 / catheterised adult with new symptoms. Requires clinician review; consider urgency based on how unwell they appear.");
          break;
        case "adult_pregnant":
          lines.push("- Pregnant with urinary symptoms. Needs same-day clinician review and urine testing.");
          break;
        case "adult_male":
          lines.push("- Adult man with urinary symptoms. Requires clinician review and usually urine testing.");
          break;
        case "child":
          lines.push("- Child with possible UTI. Requires clinician review; timing based on age, fever and overall appearance.");
          break;
        default:
          lines.push("- Pathway not selected.");
      }
    }

    lines.push("");
    lines.push("Note generated using the reception UTI screening website.");

    return lines.join("\n");
  }

  function goToAdviceStep() {
    if (!currentPatientType) {
      alert("Please choose the patient group first.");
      return;
    }
    const urinePlan = determineUrinePlan();
    const summary = buildSummaryForCurrentPath(urinePlan);
    const advice = buildClosingScript(urinePlan);

    document.getElementById("advice-text").innerText = advice;
    document.getElementById("summary-text").innerText = summary;

    showSections(["advice-section"]);
  }

  function goToSummaryStep() {
    // Show both advice and summary, with advice first on the page
    showSections(["advice-section", "summary-section"]);
  }

  async function copySummary() {
    const text = document.getElementById("summary-text").innerText;
    try {
      await navigator.clipboard.writeText(text);
      alert("Summary copied to clipboard. You can now paste it into the clinical system.");
    } catch (err) {
      alert("Sorry, copy failed. You can still highlight the text and copy it manually.");
    }
  }

  // Initialise on home screen
  resetAndGoHome();
</script>
</body>
</html>
